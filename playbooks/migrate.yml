- name: Migrate
  hosts: localhost
  connection: local
  gather_facts: False
  vars_files:
    - '../environment/group_vars/compositional/all.yml'
      #- '../environment/group_vars/compositional/vault.yml'
    - '../vars/all.yml'

  vars_prompt:
    - name: oauth_token
      prompt: "Enter your OAUTH Token"
      private: True

  pre_tasks:
    - name: Gather the values for all of the storage variables
      set_fact:
        storage_vars_list:  "{% for i in lookup('varnames', '^compositional_.+_storage', wantlist=True) %}{{ lookup('vars', i) }},{% endfor %}"

  tasks:
    - set_fact:
        oauth_token: "{{ oauth_token }}"
      no_log: True

- import_playbook: deploy_new_environment_domain_droplet.yml

- hosts: localhost
  connection: local
  gather_facts: False
  tasks:
    - name: Add newly-created droplet to new compositional host
      add_host:
        name: "{{ hostvars['localhost']['my_droplet']['data']['ip_address'] }}"
        group: 'new'

- import_playbook: ./deploy_new_block_storage_volume.yml
  when: "'remote' in hostvars['localhost']['storage_vars_list'].split(',')"

- import_playbook: transfer_data.yml

- import_playbook: all_env_services.yml
  when: inventory_hostname in groups['new']

- import_playbook: transfer_data.yml

- import_playbook: delete_oldest_environment_domain_droplet_and_block_storage.yml
