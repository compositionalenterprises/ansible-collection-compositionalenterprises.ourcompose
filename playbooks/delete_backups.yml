---
- import_playbook: 'minio_setup.yml'

- hosts: all
  vars_files:
    - ../environment/group_vars/all/all.yml
  tasks:
    - name: Keep trying to get the filelock until we can
      register: filelock
      shell: "with-lock-ex -f /var/lib/dpkg/lock-frontend sleep 1"
      until: filelock['rc'] == 0
      retries: 60
      delay: 5

    - name: Install jq
      apt:
        name: jq
        state: latest
        update_cache: True

    - name: Get all of the bucket names
      shell: "/usr/local/bin/mc --json ls backups/ocbackups | jq '.key' | tr -d '\"' | grep {{ environment_domain | replace('.', '-') }}"
      register: archive_backups_domain_archives
      # We aren't going to have this fail since the very first time there will be no results to grep,
      # which would otherwise lead to a non-zero return code.
      failed_when: False

    - name: Delete any images that need deleting
      command: "mc rm backups/ocbackups/{{ item }}"
      loop: "{{ archive_backups_domain_archives['stdout_lines'] }}"
